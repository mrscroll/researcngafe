"use strict";class ContainerNode{constructor(e){this.domNode=document.getElementById(e),this.data={}}getData(e){if(this.data.hasOwnProperty(e))return this.data[e]}setData(e,t){this.data[e]=t}setAttribute(e,t){this.domNode&&this.domNode.setAttribute(e,t)}addClass(e){this.domNode&&(this.domNode.className=[this.domNode.className,e].join(" "))}remove(){this.domNode&&this.domNode.parent&&this.domNode.parent.removeChild(this.domNode)}}class Helpers{static isObject(e,t){const r=typeof e;return e&&("object"===r||!t&&("function"===r||this.isFunction(e)))||!1}static isString(e){return"string"==typeof e}static isFunction(e){return e&&"[object Function]"==={}.toString.call(e)}static isUndefined(e){return void 0===e}static isNumber(e){return"number"==typeof e&&isFinite(e)}static hasOverlay(){return document.getElementsByClassName("has-overlay").length>0||document.querySelectorAll(".nova-has-modal").length>0}static getUrlWithoutHash(e){const t=e.indexOf("#");return-1===t?e:e.substr(0,t)}static getCollectQueueCacheKey(e){const t=e.split("/").pop().split("?").shift();return!(t.split(".").length<3)&&"dep_"+t}static loadWidgetScript(e,t,r,i){r&&window.checkEntrypoint&&window.checkEntrypoint(e),RGCommons.react.loadWidgetScript(e,t,i)}static mix(e,t,r,i,a,n){let s,o,d,l,c,p;if(!e||!t)return e;if(a){if(2===a&&this.mix(e.prototype,t.prototype,r,i,0,n),o=1===a||3===a?t.prototype:t,p=1===a||4===a?e.prototype:e,!o||!p)return e}else o=t,p=e;const g=r&&!n;if(i)for(d=0,c=i.length;d<c;++d)l=i[d],o.hasOwnProperty(l)&&(s=!g&&l in p,n&&s&&Helpers.isObject(p[l],!0)&&Helpers.isObject(o[l],!0)?this.mix(p[l],o[l],r,null,0,n):!r&&s||(p[l]=o[l]));else for(l in o)o.hasOwnProperty(l)&&(s=!g&&l in p,n&&s&&Helpers.isObject(p[l],!0)&&Helpers.isObject(o[l],!0)?this.mix(p[l],o[l],r,null,0,n):!r&&s||(p[l]=o[l]));return e}static dedupe(e){const t=e.length,r=Object.create(null),i=[];let a;for(let n=0;n<t;++n)a=e[n],r[a]||(r[a]=1,i.push(a));return i}static later(e,t,r,i,a){e=e||0,i=this.isUndefined(i)?[]:i;let n=!1;const s=t&&this.isString(r)?t[r]:r,o=()=>{n||(s.apply?s.apply(t,i||[]):s(i[0],i[1],i[2],i[3]))},d=a?setInterval(o,e):setTimeout(o,e);return{id:d,interval:a,cancel:function(){n=!0,this.interval?clearInterval(d):clearTimeout(d)}}}static isRenderableWidget(e){return!!this.isObject(e)&&!(!e.id||!e.templateName)}static updateReactStateData(e){if(!e)return;let t;RGCommons.react.initReactData(),window.reactData.initState=Helpers.mix(window.reactData.initState,e,!1,null,0,!0),"function"==typeof window.Event?t=new Event("RG.updateReactStateData"):(t=document.createEvent("Event"),t.initEvent("RG.updateReactStateData",!0,!0)),document.dispatchEvent(t)}static supportsPushState(){return!(!window.history||!history.pushState)}static unmountReactComponent(e){const t=self.reactData&&self.reactData.unmount;t&&t[e]&&(t[e](),delete t[e])}static stringify(e,t,r,i){let a,n,s,o;i||(i=[]);const d=t&&t.sep?t.sep:"&",l=t&&t.eq?t.eq:"=",c=!(!t||!t.arrayKey)&&t.arrayKey;if(null===e||this.isUndefined(e)||this.isFunction(e))return r?encodeURIComponent(r)+l:"";if("boolean"!=typeof e&&"[object Boolean]"!==Object.prototype.toString.call(e)||(e=+e),this.isNumber(e)||this.isString(e))return encodeURIComponent(r)+l+encodeURIComponent(e);if(Array.isArray(e)){for(o=[],r=c?r+"[]":r,n=e.length,a=0;a<n;a++)o.push(this.stringify(e[a],t,r,i));return o.join(d)}for(a=i.length-1;a>=0;--a)if(i[a]===e)throw new Error("this.stringify. Cyclical reference");i.push(e),o=[];const p=r?r+"[":"",g=r?"]":"";for(a in e)e.hasOwnProperty(a)&&(s=p+a+g,o.push(this.stringify(e[a],t,s,i)));return i.pop(),o=o.join(d),!o&&r?r+"=":o}}class ReactWidgetView{constructor(e){this.id=e.id,this.data={widgetId:this.id},this.pageTitle=e.pageTitle,this.pageLayout=e.pageLayout,this.reactWidgetTree=e,this.templateName="reactWrapperTemplate",this.success=!0;const t=`<div id="${this.id}" class="react-container"></div>`;this.template=Hogan.compile(t,{},"reactWrapperTemplate.html"),this._isYUI=!1,this._isReact=!0,this.initializeEventListener()}initializeEventListener(){window.addEventListener(this.getFullEventName("rendered"),()=>{const e=this.container;if(!e)throw new Error(`widget: ${this.id} is not properly implemented. widgetId missing?`);this.data.debugInfo&&e.setAttribute("data-debugInfo",this.data.debugInfo);try{this.afterRendered()}catch(e){throw new Error("Error calling afterRendered of widget "+this.id)}})}get(e){return"container"===e?this.container:null}getDefaultDialogConfig(){return{}}setContainer(e){this.container=e,e&&(e.setData("widget",this),e.addClass("js-widgetContainer"),e.addClass("yui-container"))}getFullEventName(e){return`Widget:${this.id}:${e}`}afterRendered(){widgetRenderer.prepareWidgetTree(this.reactWidgetTree,e=>{widgetLoader.renderReactWidgetTree(e,this.dialog)})}render(e){widgetRenderer.renderWidget(this,e)}fire(e){const t=this.getFullEventName(e);let r;"function"!=typeof window.CustomEvent?(r=document.createEvent("CustomEvent"),r.initCustomEvent(t,!1,!1,void 0)):r=new CustomEvent(t),window.dispatchEvent(r)}once(e,t){const r=this.getFullEventName(e),i=()=>{t(),window.removeEventListener(r,i,!1)};window.addEventListener(r,i,!1)}}class Renderer{constructor(){this.renderedWidgets=[],this.loadedStubs=[]}addStub(e,t){this.loadedStubs[e]=t}renderWidget(e,t){this.prepareWidgetTree(e,r=>{e.data=r.data,this.renderWidgetTree(e,t)})}getStub(e){if(!this.loadedStubs[e]){const t=new Error(`Can not get ${e} since it was not (completely) loaded`);throw t.name="StubLoadError",t}return this.loadedStubs[e]}addToCollectQueue(e,t){if(e.yuiModules&&(t.yuiModules=t.yuiModules.concat(e.yuiModules)),e.templateExtensions&&(t.yuiModules=t.yuiModules.concat(e.templateExtensions)),e.template&&"object"==typeof e.template||e._isReact||t.yuiModules.push(e.templateName),e.webpackCommonJs&&t.webpackCommonJs.push(...e.webpackCommonJs),Helpers.isObject(e.partials)){let r,i;for(r in e.partials)e.partials.hasOwnProperty(r)&&(i=e.partials[r],"string"==typeof i&&t.yuiModules.push(i))}t.yuiModules=Helpers.dedupe(t.yuiModules)}collectData(e,t){let r,i;if(e&&"object"==typeof e&&!e._isReact)if(e.templateName)for(i in e.toString=()=>{r=YRG.rg.WidgetView.getInstance(e);const t="<noscript></noscript>"+this.internalRenderWidget(r);return"application/stubs/AsyncClientSideRenderingWrapper.html"===e.templateName&&r.on("rendered",()=>{const t=new ContainerNode(e.id);widgetLoader.loadAndRenderAsyncWidget(t,e.data)}),this.renderedWidgets.push(r),t},this.addToCollectQueue(e,t),e.data)e.data.hasOwnProperty(i)&&(e.data[i]=this.collectData(e.data[i],t));else for(i in e)e.hasOwnProperty(i)&&(e[i]=this.collectData(e[i],t));else if(e&&"object"==typeof e&&e._isReact)for(i in e.toString=()=>{r=new ReactWidgetView(e);const t=this.internalRenderWidget(r);return this.renderedWidgets.push(r),t},this.addToCollectQueue(e,t),e.data)e.data.hasOwnProperty(i)&&(e.data[i]=this.collectData(e.data[i],t));return e}retrieveData(e,t,r){this.retrieveWebpackScripts(t.webpackCommonJs).then(()=>{t.yuiModules&&Array.isArray(t.yuiModules)&&t.yuiModules.length>0?YRG.use(t.yuiModules,()=>{r&&r(e)}):r&&r(e)})}retrieveWebpackScripts(e){return Array.from(new Set(e)).reduce((e,t)=>RGCommons.script.loadWebpackScript(t),Promise.resolve())}prepareWidgetTree(e,t){const r={yuiModules:[],webpackCommonJs:[]};(e=this.collectData(e,r)).collectQueueCacheKey&&lscache.set(e.collectQueueCacheKey,r,2880),this.retrieveData(e,r,e=>{t&&t(e)})}callRenderer(e,t,r){let i,a;if(t.hasOwnProperty("replace"))i=YRG.rg.widget.ReplaceRenderer,a=t.replace;else if(t.hasOwnProperty("replaceContent"))i=YRG.rg.widget.ReplaceContentRenderer,a=t.replaceContent;else if(t.hasOwnProperty("append"))i=YRG.rg.widget.AppendRenderer,a=t.append;else if(t.hasOwnProperty("prepend"))i=YRG.rg.widget.PrependRenderer,a=t.prepend;else if(t.hasOwnProperty("beforeNode"))i=YRG.rg.widget.BeforeNodeRenderer,a=t.beforeNode;else if(t.hasOwnProperty("afterNode"))i=YRG.rg.widget.AfterNodeRenderer,a=t.afterNode;else if(t.hasOwnProperty("refresh"))i=YRG.rg.widget.RefreshRenderer,a=t.refresh;else if(t.hasOwnProperty("dialog"))i=YRG.rg.widget.DialogRenderer,a=t.dialog;else if(t.hasOwnProperty("dialogSections"))i=YRG.rg.widget.DialogSectionRenderer,a=t.dialogSections;else if(t.hasOwnProperty("openedDialog"))i=YRG.rg.widget.OpenedDialogRenderer.renderDialog,a=t.openedDialog;else if(t.hasOwnProperty("tooltip"))i=YRG.rg.widget.TooltipRenderer.renderTooltip,a=t.tooltip;else{if(!t.hasOwnProperty("renderer")||"function"!=typeof t.renderer)throw new Error("no valid renderer specified");i=t.renderer,a={}}if(!1===i(e,r,a))return this.renderedWidgets=[],!1;this.renderedWidgets&&Array.isArray(this.renderedWidgets)&&this.renderedWidgets.map(e=>{const t=new ContainerNode(e.id);t&&e.setContainer(t)}),this.renderedWidgets.push(e),"function"==typeof t.afterRendered&&e.once("rendered",()=>{t.afterRendered.call(e,e.get("container"))}),"function"==typeof t.after&&!1===t.after.call(e,e.get("container"),YRG.bind(()=>{this.checkForRenderEvent()}))||this.checkForRenderEvent()}checkForRenderEvent(){let e;for(;e=this.renderedWidgets.shift();)this.fireRenderEvent(e)}fireRenderEvent(e){if(!0===e._isReact)return void e.fire("rendered");const t=e.get("container");t&&e.fire("rendered",t)}attachTemplateExtension(e,t,r){let i;for(i in window[t])window[t].hasOwnProperty(i)&&(e.hasOwnProperty(i)&&YRG.log(`Template data key ${i} was overwritten by mustache extension function for widget ${r}`),e[i]=window[t][i]);return e}internalRenderWidget(e){const t=e.data;let r;if(YRG.Array.each(e.templateExtensions,r=>{this.attachTemplateExtension(t,r,e.templateName)}),e.template||(r=this.getStub(e.templateName),e.template=this.createHoganTemplate(r.compiledTemplate,r.templateString)),Helpers.isObject(e.partials)){let t,i;for(t in e.partials)e.partials.hasOwnProperty(t)&&(i=e.partials[t],"string"==typeof i&&(r=this.getStub(i),e.partials[t]=this.createHoganTemplate(r.compiledTemplate,r.templateString)))}return e.template.render(t,e.partials)}createHoganTemplate(e,t){if(!e)throw new Error("Invalid compiled template given");const r=new Function("c","p","i",`var tpl = ${e}; return tpl.call(this, c, p, i);`);return new Hogan.Template(r,t,Hogan,{})}renderWidgetTree(e,t){const r=YRG.Node.create(this.internalRenderWidget(e));"function"==typeof t.before&&!1===t.before.call(e,r,YRG.bind(()=>{this.callRenderer(e,t,r)}))||this.callRenderer(e,t,r)}}const widgetRenderer=new Renderer;class WidgetLoader{constructor(){this.preloadedWidgets=[],"object"==typeof console&&console.log&&(console.log("%cWARNING!","color:white; background:red; font-size: 16pt"),console.log("%cUsing this console may allow attackers to impersonate you and steal your information using an attack called Self-XSS. Do not enter or paste code that you do not understand.","font-size: 14pt")),YRG.use(["rg.WidgetView","rg-widgetloader-renderers","rg-widgetloader-pushstate","rg-tooltip"])}preloadWidget(e,t,r,i){e=Helpers.getUrlWithoutHash(e),t=t||{};const a=e+JSON.stringify(t);this.preloadedWidgets[a]||i&&"object"==typeof lscache&&lscache.get(i)||(this.preloadedWidgets[a]={state:"loading",keep:!!r},YRG.rg.ajaxDbwAware(e,t,r=>{this.preloadedWidgets[a].widget=r,"render"!==this.preloadedWidgets[a].state?(this.preloadedWidgets[a].state="loaded",r.success&&widgetRenderer.prepareWidgetTree(r.result)):this.loadWidget(e,t,this.preloadedWidgets[a].callback,this.preloadedWidgets[a].context)}))}loadWidgetInDialog(e,t,r,i,a,n,s,o,d){let l=!1;!0===d?(YRG.one("body").addClass("rg-overlay-dark"),l=!0):(YRG.one("body").removeClass("rg-overlay-dark"),l=!1),YRG.rg.widget.OverlayCloseable.prototype.initializer=function(){this.afterHostMethod("renderUI",(function(){const e=this.get("host"),t=e.get("contentBox"),r=YRG.Node.create('<div class="close"><a class="dialog-close js-dialog-close" href="javascript:" onclick="return false;"></a></div>'),i=r.one(".js-dialog-close");t.setStyle("position","relative"),l?i.setContent('<span class="ico-close-bold-big"></span><span class="ico-close-bold-big-hover"></span>'):i.setContent('<span class="ico-x-close-light"></span>'),t.append(r),i.on("click",e.hide,e)}),this)};const c=YRG.rg.widget.OpenedDialogRenderer.createDialog(s,o);this.loadWidget(e,t,e=>{if(!e.success)return c.destroy(),void(Helpers.isFunction(a)?a.call(i,e.errors):YRG.use("rg-header-notify",t=>t.rg.notify(e.errors,"warning")));const t={openedDialog:c,after:r};widgetRenderer.renderWidget(e,t)},i,!1,n)}createWidget(e,t,r,i){if(!Helpers.isRenderableWidget(e))return;const a=(new Date).getTime();let n;const s=e=>{e.data.renderTime=n-a,e.data.completeRequestTime=e.data.backendTime+e.data.renderTime,Helpers.later(50,null,()=>RGCommons.monitoring.trackByImage(e.ep,e.data))},o=e=>{e.once("rendered",()=>(n=(new Date).getTime(),void(Array.isArray(i)?i.map(e=>{s(e)}):s(i))))};Helpers.updateReactStateData(e.state);let d=e.yuiModules;if(d||(d=[]),e.collectQueueCacheKey){const t=lscache.get(e.collectQueueCacheKey);t&&t.yuiModules&&(d=d.concat(t.yuiModules),d=Helpers.dedupe(d))}const l=()=>{let a;a=e._isReact?new ReactWidgetView(e):YRG.rg.WidgetView.getInstance(e),i&&o(a),t.call(r,a)};d.length>0?YRG.use(d,l):l()}createInitialWidget(e){widgetRenderer.prepareWidgetTree(e,e=>{this.attachWidgetTree(e)})}loadAndRenderAsyncWidget(e,t){if(!e)throw new Error("Missing container for async load of "+t.innerWidgetUrl);if(!(e=e.domNode?YRG.one(e.domNode):e))throw new Error("Missing container for async load of "+t.innerWidgetUrl);this.loadWidget(t.innerWidgetUrl,{},r=>{if(!r.success)return void e.remove(!0);const i={replace:e,after:e=>{t.hasPlaceHolder&&(e.hide(),YRG.rg.fadeToggle(e,null,{duration:1}))}};widgetRenderer.renderWidget(r,i)},this,null,"GET",{"X-Rg-AsyncLoad":1},t.innerWidgetCacheKey,t.innerWidgetTTL)}loadWidget(e,t,r,i,a,n,s,o,d){n=n||"GET",e=Helpers.getUrlWithoutHash(e);const l=Helpers.getCollectQueueCacheKey(e);if(l){const e=lscache.get(l);e&&e.yuiModules&&YRG.use(e.yuiModules)}const c=e=>{e.success?(l&&(e.result.collectQueueCacheKey=l),o&&"object"==typeof lscache&&lscache.set(o,e,d),this.createWidget(e.result,r,i,e.tracking)):r.call(i,{render:()=>{throw new Error("WidgetError: "+JSON.stringify(e.errors))},success:e.success,errors:e.errors,errorCode:e.result.errorCode,correlationId:e.result.correlationId})};if(o&&"object"==typeof lscache){const e=lscache.get(o);if(e)return void this.createWidget(e.result,r,i,e.tracking)}const p=e+JSON.stringify(t);if(this.preloadedWidgets[p]){const e=this.preloadedWidgets[p];if(Helpers.isString(e.state)&&"loading"===e.state)return this.preloadedWidgets[p].state="render",this.preloadedWidgets[p].callback=r,void(this.preloadedWidgets[p].context=i);if(!e.widget)return;return c(e.widget),void(e.keep||delete this.preloadedWidgets[p])}return YRG.rg.ajaxDbwAware(e,t,c,i,null,n,s)}attachWidgetTree(e){if(Helpers.updateReactStateData(e.initState),e._isYUI){this.resolveWidgetDataArray(e.data);const t=YRG.one("#"+e.id);if("application/stubs/AsyncClientSideRenderingWrapper.html"===e.templateName)return void this.loadAndRenderAsyncWidget(t,e.data);const r=YRG.rg.WidgetView.getInstance(e);if(!t)return YRG.log(`Cannot find container in DOM for widget "${e.id}".`,"warn"),YRG.log(r),null;r.setContainer(t),r.fire("rendered",t)}else e._isReact&&this.renderReactWidgetTree(e)}renderReactWidgetTree(e,t){void 0===t&&(t=null),RGCommons.react.initReactData(),this.resolveReactWidgetDataArray(e);const r=e.templateName,i=e.webpackEntryFile,a=e.id;t&&window.reactData.widgets[a]&&(window.reactData.widgets[a].data.dialog=t),Helpers.loadWidgetScript(r,i,!0,()=>{window["renderReact_"+r]&&window["renderReact_"+r](a)})}resolveReactWidgetDataArray(e){let t;if(e&&"object"==typeof e){if(!e._isYUI)for(t in e)e.hasOwnProperty(t)&&(e[t]=this.resolveReactWidgetDataArray(e[t]));if(e.templateName){const t=e.id;return window.reactData.widgets[t]=e,t}}return e}resolveWidgetDataArray(e){for(const t in e)e.hasOwnProperty(t)&&e[t]&&(e[t].templateName&&(e[t]._isYUI||e[t]._isReact)?this.attachWidgetTree(e[t]):(e[t]instanceof Array||e[t]instanceof Object)&&this.resolveWidgetDataArray(e[t]))}}const widgetLoader=new WidgetLoader;